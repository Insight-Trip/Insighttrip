<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=0, initial-scale=1.0">
    <title>Insight Trip | Chart-map</title>
    <!-- css -->
    <link rel="stylesheet" href="./css/chartMapa.css">
    <link rel="stylesheet" href="../global/mapin.css">
    <link rel="stylesheet" href="./css/sidebar.css">
    <!-- script -->
    <script src="./dist/mapa-brasil.min.js" defer></script>
</head>

<body>
    <div class="sidebar" id="sidebar">
        <div class="area-logo">
            <p class="logo-text">Insight Trip</p>
        </div>

        <div class="menu-sidebar">
            <div class="card-navbar navbar-card-dashboard activate">
                <!-- abaixo a estrutura svg para o icone da dashboard -->
                <svg class="dashboard-icon" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    xmlns="http://www.w3.org/2000/svg">
                    <path d="M5 10H7C9 10 10 9 10 7V5C10 3 9 2 7 2H5C3 2 2 3 2 5V7C2 9 3 10 5 10Z" stroke="#202020"
                        stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M17 10H19C21 10 22 9 22 7V5C22 3 21 2 19 2H17C15 2 14 3 14 5V7C14 9 15 10 17 10Z"
                        stroke="#202020" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round"
                        stroke-linejoin="round" />
                    <path
                        d="M17 22H19C21 22 22 21 22 19V17C22 15 21 14 19 14H17C15 14 14 15 14 17V19C14 21 15 22 17 22Z"
                        stroke="#202020" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round"
                        stroke-linejoin="round" />
                    <path d="M5 22H7C9 22 10 21 10 19V17C10 15 9 14 7 14H5C3 14 2 15 2 17V19C2 21 3 22 5 22Z"
                        stroke="#202020" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>

                <p>Dashboard</p>
            </div>

            <div class="card-navbar navbar-card-funcionarios" onclick="navigate(1)">
                <!-- Abaixo a estrutura svg para o icone do funcionarios -->
                <svg width="18.5" height="18" viewBox="0 0 27 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path opacity="1"
                        d="M19.1818 23V20.5556C19.1818 19.2589 18.7029 18.0154 17.8505 17.0986C16.998 16.1817 15.8419 15.6667 14.6364 15.6667H5.54545C4.33993 15.6667 3.18377 16.1817 2.33133 17.0986C1.47889 18.0154 1 19.2589 1 20.5556V23M26 23V20.5556C25.9992 19.4723 25.664 18.4201 25.047 17.5639C24.43 16.7078 23.5661 16.0964 22.5909 15.8256M18.0455 1.15889C19.0232 1.42815 19.8898 2.03975 20.5087 2.89727C21.1275 3.75479 21.4635 4.80946 21.4635 5.895C21.4635 6.98054 21.1275 8.03521 20.5087 8.89273C19.8898 9.75025 19.0232 10.3619 18.0455 10.6311M14.6364 5.88889C14.6364 8.58895 12.6013 10.7778 10.0909 10.7778C7.58052 10.7778 5.54545 8.58895 5.54545 5.88889C5.54545 3.18883 7.58052 1 10.0909 1C12.6013 1 14.6364 3.18883 14.6364 5.88889Z"
                        stroke="#202020" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>

                <p>Funcionários</p>
            </div>
        </div>

        <div class="box-sidebar-next-event">
            <div class="area-desc-next-event">
                <p class="desc">Possibilidade para proximo clima</p>
                <p class="tittle">Viagem litorania</p>
            </div>
            <div class="area-event">
                <p>05/12 - RIO DE JANEIRO</p>
                <button class="chat-ia-button">conversar com I.A</button>
                <button class="compreender-demanda">compreender Demanda</button>
            </div>
        </div>
    </div>

    <div class="display-mapa">
        <div class="show-mapa" id="mapa"></div>

        <div class="box-voltar-dash" onclick="backToDash()">
            <svg width="65" height="65" viewBox="0 0 65 65" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="32.5" cy="32.5" r="32" fill="white" />
                <path d="M33 49V29M45 49V17M21 49V41" stroke="#1E1E1E" stroke-width="4" stroke-linecap="round"
                    stroke-linejoin="round" />
            </svg>

            voltar a dashboard
        </div>
    </div>
</body>

<script src="../global/core.js"></script>
<script src="js/sidebar.js"></script>


<!-- <br>
<input type="button" value="Brasil Federacao" onclick="brasilFederacao()">
<input type="button" value="Brasil Mesorregiao" onclick="brasilMesorregiao()">
<input type="button" value="Brasil Microrregiao" onclick="brasilMicroregiao()">
<input type="button" value="Brasil Município" onclick="brasilMunicipio()">
<br>
<br>
<input type="button" value="Brasil -> Mesorregiao" onclick="brasilGoToMesorregiao()">
<input type="button" value="Brasil -> Microrregiao" onclick="brasilGoToMicroregiao()">
<input type="button" value="Brasil -> Município" onclick="brasilGoToMunicipio()">
<input type="button" value="Município 6 digitos" onclick="municipio6Digitos()"> -->

<script type="text/javascript">

    function backToDash() {
        window.location = "../dashboard/dashboard.html"
    }


    function define() {
        const slide = 2;

        switch (slide) {
            case 0:
                return brasilFederacao
                break;
            case 1:
                return brasilGoToMesorregiao
                break;
            case 2:
                return brasilGoToMunicipio
                break
            case 3:
                return brasilMicroregiao
                break
        }
    }

    function brasilFederacao() {
        const contexto = JSON.parse(sessionStorage.getItem('contexto'));
        console.log(contexto)
        // Primeiro buscar os dados do ranking
        fetch('dashboard/buscarDados', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user: contexto.user,
                evento : contexto.evento
            })
        })
        .then(response => response.json())
        .then(dados => {

            if (!Array.isArray(dados)) {
                // Se for um objeto, converte para array se possível
                dados = Object.values(dados);
            }
            console.log(dados)
            console.log(dados[1][0].resultado.dados_estado)
            // Extrair dados do ranking de estados
            const dadosEstado = dados[1][0].resultado.dados_estado;
            console.log("resuotado dDOA WA",dadosEstado)
            
            // Ordenar estados por ranking (usando porcentagem_viagens/porcentagem_crimes como métrica)
            const estadosOrdenados = dadosEstado.sort((a, b) => {
                const rankingA = a.porcentagem_viagens / a.porcentagem_crimes;
                const rankingB = b.porcentagem_viagens / b.porcentagem_crimes;

                console.log(rankingB - rankingA)
                return rankingB - rankingA;
            });

            // Dividir estados em 4 grupos
            const totalEstados = estadosOrdenados.length;
            const estadosPorGrupo = Math.ceil(totalEstados / 4);
            
            // Criar configuração de cores para o mapa
            const unidadeData = estadosOrdenados.map((estado, index) => {
                let fillColor;
                if (index < estadosPorGrupo) {
                    fillColor = '#d82b40'; // Alta demanda x segurança
                } else if (index < estadosPorGrupo * 2) {
                    fillColor = '#e84d5b'; // Média-alta demanda x segurança
                } else if (index < estadosPorGrupo * 3) {
                    fillColor = '#f47680'; // Média demanda x segurança
                } else {
                    fillColor = '#ffa3a3'; // Baixa demanda x segurança
                }

                return {
                    codIbge: estado.id_estado,
                    fillColor: fillColor
                };
            });

            // Renderizar o mapa com as cores atualizadas
            MapaBrasil(document.getElementById('mapa'), {
                unidadeData: unidadeData,
                onClick: function (data) { console.log(data) }
            });
        })
        .catch(error => {
            console.error('Erro ao buscar dados:', error);
            // Fallback para cores padrão em caso de erro
            MapaBrasil(document.getElementById('mapa'), {
                unidadeData: [
                    // Cores padrão como estavam antes
                    { codIbge: 29, fillColor: '#d82b40' },
                    // ... resto do código original ...
                ],
                onClick: function (data) { console.log(data) }
            });
        });
    }

    function brasilMunicipio() {
        MapaBrasil(document.getElementById('mapa'), {
            regiao: 'municipio',
            onClick: function (data) { console.log(data) }
        });
    }

    function brasilMesorregiao() {
        MapaBrasil(document.getElementById('mapa'), {
            regiao: 'mesorregiao',
            onClick: function (data) { console.log(data) }
        });
    }

    function brasilMicroregiao() {
        MapaBrasil(document.getElementById('mapa'), {
            regiao: 'microrregiao',
            onClick: function (data) { console.log(data) }
        });
    }

    // GO TO
    function brasilGoToMunicipio() {
        MapaBrasil(document.getElementById('mapa'), {
            onClick: function (data) {
                console.log(data);
                MapaBrasil(document.getElementById('mapa'), {
                    unidade: data.codIbge,
                    regiao: 'municipio',
                    onClick: function (data) {
                        console.log(data)
                    }
                });
            }
        });
    }

    function brasilGoToMesorregiao() {
        MapaBrasil(document.getElementById('mapa'), {
            onClick: function (data) {
                console.log(data);
                MapaBrasil(document.getElementById('mapa'), {
                    unidade: data.codIbge,
                    regiao: 'mesorregiao',
                    onClick: function (data) {
                        console.log(data)
                    }
                });
            }
        });
    }

    function brasilGoToMicroregiao() {
        MapaBrasil(document.getElementById('mapa'), {
            onClick: function (data) {
                console.log(data);
                MapaBrasil(document.getElementById('mapa'), {
                    unidade: data.codIbge,
                    regiao: 'microrregiao',
                    onClick: function (data) {
                        console.log(data)
                    }
                });
            }
        });
    }

    function municipio6Digitos() {
        MapaBrasil(document.getElementById('mapa'), {
            unidade: 11,
            regiao: 'municipio',
            unidadeData: [
                { codIbge: 110001, fillColor: '#d82b40' }
            ],
            onClick: function (data) {
                console.log(data)
            }
        });
    }

    window.onload = function () {
        brasilFederacao();
    }
</script>

</html>